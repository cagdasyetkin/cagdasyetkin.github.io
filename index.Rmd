---

---
<b> 2018.24.02, 17:40 </b>

```{r, warning=FALSE, message=FALSE, results='hide', echo=FALSE}
library(stringr)
library(dplyr)
library(tidyr)
library(tidytext)
library(ggplot2)
library(ggthemes)
library(gridExtra)
library(scales)
library(broom)
library(purrr)
library(SnowballC)
library(tm)
```
We are loading the Game of Thrones books. The goal is to check how document term matrix looks like and get the sentiments from the books.
```{r}
GoT1 <- readLines("GoT1.txt") %>%
  data_frame() %>%
  mutate(title = "A Game of Thrones")

GoT2 <- readLines("GoT2.txt") %>%
  data_frame() %>%
  mutate(title = "A Clash of Kings") 

GoT3 <- readLines("GoT3.txt") %>%
  data_frame() %>%
  mutate(title = "A Storm of Swords") 

GoT4 <- readLines("GoT4.txt") %>%
  data_frame() %>%
  mutate(title = "A Feast of Crows") 

GoT5 <- readLines("GoT5.txt") %>%
  data_frame() %>%
  mutate(title = "A Dance with Dragons") 

Thrones <- bind_rows(list(GoT1, GoT2, GoT3, GoT4, GoT5)) 
colnames(Thrones) <- c("text", "title")
```

Converting them to Tidy format
```{r, message=FALSE}
Tidy_Thrones <- Thrones %>%
  group_by(title) %>%
  ungroup() %>%
  unnest_tokens(word, text) %>%
  mutate(word_stem = wordStem(word)) %>%
  anti_join(stop_words)

```

Creating a document term matrix
```{r}
dtm_words_count <- Tidy_Thrones %>%
  mutate(word_stem = removeNumbers(word_stem)) %>%
  count(title, word_stem, sort = TRUE) %>%
  ungroup() %>%
  filter(word_stem != "") %>%
  cast_dtm(title, word_stem, n)

dtm_words_count
```

and checking a few terms...
```{r, results=FALSE}
terms <- Terms(dtm_words_count)
head(terms)
```

the word 'ser' means 'sir' in Game of Thrones novels.

Now get back to tidy format:
```{r, fig.width=7,fig.height=4}
words_count <- tidy(dtm_words_count)
```

Get the sentiments from bing lexicon:
```{r}
GoT_sentiments <- words_count %>%
  inner_join(get_sentiments("bing"), by = c(term = "word"))

GoT_sentiments
```
Terms look just like some song lyrics from a power-metal band.

Can we plot them anyway:


```{r, warning=FALSE, fig.width=6,fig.height=3}

GoT_sentiments %>%
  count(sentiment, term, wt = count) %>%
  ungroup() %>%
  filter(n >= 1000) %>%
  mutate(n = ifelse(sentiment == "negative", -n, n)) %>%
  mutate(term = reorder(term, n)) %>%
  ggplot(aes(term, n, fill = sentiment)) +
  geom_bar(stat = "identity") +
  ggtitle("Contribution to sentiment") +
  coord_flip() + theme_fivethirtyeight()
```

Seems like bloody hell :) By the way, the word 'start' is actually the name of one dynasty. Starks are the family who rules the nordic lands in Westeros. So we will remove it form the sentiment in our next iteration.


```{r}
tidy(dtm_words_count) %>%
  filter(document == 1) %>%
  arrange(desc(count))
```

<b> 2018.24.02 </b>

Today we are looking at a quick sentiment analysis of Game of Thrones novels


```{r, warning=FALSE, message=FALSE, echo=FALSE}
GoT1 <- readLines("GoT1.txt") %>%
  data_frame() %>%
  mutate(title = "A Game of Thrones")

GoT2 <- readLines("GoT2.txt") %>%
  data_frame() %>%
  mutate(title = "A Clash of Kings") 

GoT3 <- readLines("GoT3.txt") %>%
  data_frame() %>%
  mutate(title = "A Storm of Swords") 

GoT4 <- readLines("GoT4.txt") %>%
  data_frame() %>%
  mutate(title = "A Feast of Crows") 

GoT5 <- readLines("GoT5.txt") %>%
  data_frame() %>%
  mutate(title = "A Dance with Dragons") 

Thrones <- bind_rows(list(GoT1, GoT2, GoT3, GoT4, GoT5)) 
colnames(Thrones) <- c("text", "title")

```


```{r, message=FALSE}
Sentiment_Thrones <- Thrones %>%
  group_by(title) %>%
  mutate(linenumber = row_number(), ignore_case = TRUE) %>%
  ungroup() %>%
  unnest_tokens(word, text) %>%
  
  inner_join(get_sentiments("bing")) %>%
  count(title, index = linenumber %/% 80, sentiment) %>%
  spread(sentiment, n, fill = 0) %>%
  mutate(sentiment = positive - negative) %>%

  ggplot(aes(index, sentiment, fill = title)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~title, ncol = 2, scales = "free_x") +
  theme_fivethirtyeight()

Sentiment_Thrones


```


We will research if such negativity is real... Can be... Everybody is dying afterall.




<b> 2018.23.02 </b>

Let's have a look at Game of Thrones, 5 huge volumes

```{r, warning=FALSE, message=FALSE}
GoT1 <- readLines("GoT1.txt") %>%
  data_frame() %>%
  mutate(title = "A Game of Thrones")

GoT2 <- readLines("GoT2.txt") %>%
  data_frame() %>%
  mutate(title = "A Clash of Kings") 

GoT3 <- readLines("GoT3.txt") %>%
  data_frame() %>%
  mutate(title = "A Storm of Swords") 

GoT4 <- readLines("GoT4.txt") %>%
  data_frame() %>%
  mutate(title = "A Feast of Crows") 

GoT5 <- readLines("GoT5.txt") %>%
  data_frame() %>%
  mutate(title = "A Dance with Dragons") 

Thrones <- bind_rows(list(GoT1, GoT2, GoT3, GoT4, GoT5)) 
colnames(Thrones) <- c("text", "title")


```

Convert to Tidy format
```{r, message=FALSE}
Tidy_Thrones <- Thrones %>%
  unnest_tokens(word, text) %>%
  anti_join(stop_words)
```
Have a look at the top 10 words in these books
```{r, results=FALSE}
Tidy_Thrones %>%
  count(word, sort = TRUE) %>%
  head(10)
  
```

Looks like lots of lords, sirs and ladies around Jon Snow and Tyrion Lennister :)

```{r, fig.width=4,fig.height=3}

Tidy_Thrones %>%
          count(word, sort = TRUE) %>%
          filter(n > 2300) %>%
          mutate(word = reorder(word, n)) %>%
          ggplot(aes(word, n)) + geom_col() + xlab(NULL) + coord_flip() +
          ggtitle("A Song of Ice and Fire") +
          theme_fivethirtyeight()
```

Now lets see tf-idf to see the most **important** words in these books.

```{r, message=FALSE}
Tidy_Thrones <- Tidy_Thrones %>%
  anti_join(stop_words) %>%
  count(title, word, sort = TRUE) %>%
  ungroup()

Tidy_Thrones_total_words <- Tidy_Thrones %>% 
  group_by(title) %>% 
  summarize(total = sum(n))

Tidy_Thrones <- left_join(Tidy_Thrones, Tidy_Thrones_total_words)

```

```{r}
Tidy_Thrones <- Tidy_Thrones %>%
  bind_tf_idf(word, title, n)
head(Tidy_Thrones)

```

```{r}
Tidy_Thrones %>%
  select(-total) %>%
  arrange(desc(tf_idf)) %>%
  head()

```


```{r, fig.height=12, fig.width=8, message=FALSE}

Tidy_Thrones %>%
        arrange(desc(tf_idf)) %>%
        mutate(word = factor(word, levels = rev(unique(word)))) %>% 
        group_by(title) %>% 
        top_n(10) %>% 
        ungroup %>%
        ggplot(aes(word, tf_idf, fill = title)) +
        geom_col(show.legend = FALSE) +
        labs(x = NULL, y = "tf-idf") +
        facet_wrap(~title, ncol = 2, scales = "free") +
        theme_fivethirtyeight() + ggtitle("A Song of Ice and Fire") +
        coord_flip()
```

Looks like I will need to do **a bit** cleaning :)

<b> 2018.22.02 </b>
A few days ago, I learnt that it is possible to keep a blog up and running using Github and RStudio from our instructor Eduardo Ari√±o de la Rubia.


